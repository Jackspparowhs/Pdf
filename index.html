<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Math Solver — PirateRuler</title>
<meta name="description" content="Mathematical Problem Solver — PirateRuler. Client-side solver for expressions, linear & quadratic equations, functions, with step-by-step." />
<meta name="theme-color" content="#f7fbff" />
<link rel="icon" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect rx="14" width="64" height="64" fill="%236b7dff"/><text x="50%" y="50%" font-family="Inter,Arial,sans-serif" font-weight="800" font-size="26" text-anchor="middle" alignment-baseline="central" fill="white">PR</text></svg>'>
<style>
  /* --- visually matches your Calculator theme --- */
  :root{
    --bg:#f3f7fb; --card:#ffffff; --muted:#6b7480; --text:#0b2130;
    --accent-start:#6b7dff; --accent-end:#0bb3ff;
    --glass: rgba(11,17,28,0.04);
    --radius:14px;
    --shadow-lg: 0 18px 50px rgba(3,12,30,0.18), inset 0 1px 0 rgba(255,255,255,0.6);
    --shadow-sm: 0 8px 24px rgba(3,12,30,0.08);
  }
  html.dark { --bg:#071225; --card:#061028; --muted:#98a7bf; --text:#e9f1ff; --glass: rgba(255,255,255,0.02); --accent-start:#5ab3ff; --accent-end:#6b7dff; }
  html.ocean { --bg:#e8f7fb; --card:#ffffff; --muted:#4f6b75; --text:#063242; --accent-start:#00c2d1; --accent-end:#2b9fff; }
  html.sunset { --bg:#fff6f8; --card:#fff; --muted:#7a6b77; --text:#2a1020; --accent-start:#ff7aa2; --accent-end:#ffb86b; }

  *{box-sizing:border-box}
  body{background:linear-gradient(180deg,var(--bg), #e9f6ff); font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; color:var(--text); margin:0; -webkit-font-smoothing:antialiased;}
  .container{max-width:1280px;margin:14px auto;padding:18px;}

  header.header { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px; border-radius:14px; background:linear-gradient(90deg, rgba(107,125,255,0.06), rgba(11,179,255,0.02)); box-shadow:var(--shadow-sm); }
  .brand {display:flex; align-items:center; gap:12px;}
  .logo { width:60px;height:60px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-weight:800; background:linear-gradient(135deg,var(--accent-start),var(--accent-end)); color:white; font-size:20px; box-shadow:0 10px 30px rgba(11,123,255,0.12); }
  .brand-title .title-strong {font-size:22px;font-weight:900;margin:0}
  .brand-title .by {font-size:12px;color:var(--muted); margin-top:3px}
  .header-actions {display:flex; gap:10px; align-items:center;}
  .btn {padding:9px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .btn.ghost {background:transparent;border:1px solid rgba(0,0,0,0.06);}
  .btn.theme {background:linear-gradient(90deg,var(--accent-start),var(--accent-end)); color:white}
  .hamb { width:46px;height:46px;border-radius:10px;background:var(--glass);display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid rgba(0,0,0,0.04) }

  .theme-select { position:relative; }
  .theme-list { position:absolute; right:0; top:48px; background:var(--card); border-radius:10px; box-shadow:var(--shadow-sm); padding:8px; display:none; min-width:140px; z-index:1000; }
  .theme-item { padding:8px 10px; cursor:pointer; border-radius:8px; font-weight:700; color:var(--muted); }

  .hero { margin-top:18px; padding:28px;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96)); box-shadow:var(--shadow-lg); }
  .hero .big {font-size:34px;font-weight:900;margin:0;text-align:center}
  .hero .small {text-align:center;color:var(--muted);margin-top:8px; max-width:960px;margin-left:auto;margin-right:auto}

  .grid { display:grid; grid-template-columns: 2fr 1fr; gap:18px; margin-top:12px; align-items:start; }
  @media (max-width:980px){ .grid{ grid-template-columns: 1fr } }
  .card { background:var(--card); border-radius:14px; padding:18px; box-shadow:var(--shadow-sm); border:1px solid rgba(0,0,0,0.04); }
  .card h2{margin:0 0 8px 0;font-size:18px}
  .hint{color:var(--muted); font-size:13px; margin-bottom:10px}

  input[type="text"], select, textarea { width:100%; padding:12px;border-radius:10px;border:1px solid rgba(10,20,40,0.06); font-size:15px; background:transparent; color:var(--text); }
  textarea { min-height:120px; resize:vertical; }
  .row {display:flex; gap:10px}
  .primary { background:linear-gradient(90deg,var(--accent-start),var(--accent-end)); color:white; padding:9px 14px; border-radius:10px; border:none; font-weight:800; cursor:pointer }
  .ghost { background:transparent; border:1px solid rgba(0,0,0,0.06); padding:9px 12px;border-radius:10px; cursor:pointer }
  .result { margin-top:12px; font-weight:800; color:#0b8a66 } html.dark .result { color:#57f0b6 }
  .muted{color:var(--muted)}

  .controls-grid { display:grid; grid-template-columns: 1fr 160px 120px 120px; gap:10px; align-items:center; }
  @media(max-width:900px){ .controls-grid { grid-template-columns: 1fr; } }

  .result-block { white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; background:linear-gradient(180deg, rgba(0,0,0,0.01), transparent); padding:12px; border-radius:10px; border:1px solid rgba(0,0,0,0.04); margin-top:12px; }

  .history-list { display:flex; flex-direction:column; gap:8px; margin-top:10px; }
  .history-item { padding:10px; border-radius:10px; background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent); border:1px solid rgba(0,0,0,0.04); display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .history-item button { font-weight:700; padding:6px 8px; border-radius:8px; }

  footer { margin-top:16px; padding:16px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.96)); text-align:center; box-shadow:var(--shadow-lg) }
  .visit { padding:12px 20px; border-radius:999px; display:inline-block; background:linear-gradient(90deg,#ff7aa2 0%, #6b7dff 100%); color:white; font-weight:800; text-decoration:none }
</style>
</head>
<body>
<div class="container">
  <header class="header" role="banner">
    <div class="brand">
      <div class="logo" aria-hidden="true">PR</div>
      <div class="brand-title">
        <div class="title-strong">Math Solver</div>
        <div class="by">by PirateRuler.com</div>
      </div>
    </div>

    <div class="header-actions">
      <div class="theme-select" id="themeSelectWrap">
        <button id="themeBtn" class="btn theme">Ocean ▾</button>
        <div id="themeList" class="theme-list" aria-hidden="true">
          <div class="theme-item" data-theme="light">Light</div>
          <div class="theme-item" data-theme="dark">Dark</div>
          <div class="theme-item" data-theme="ocean">Ocean</div>
          <div class="theme-item" data-theme="sunset">Sunset</div>
        </div>
      </div>

      <div id="hambBtn" class="hamb" title="Open menu">☰</div>
    </div>
  </header>

  <section class="hero" aria-labelledby="heroTitle">
    <h1 id="heroTitle" class="big">Mathematical Problem Solver</h1>
    <p class="small">Solve expressions, linear & quadratic equations, and evaluate functions — offline, client-side, with steps.</p>

    <div style="margin-top:14px">
      <div class="controls-grid">
        <input id="inputProblem" type="text" placeholder="Enter expression or equation — e.g. 3*(2+1)  OR  2x+3=7  OR  x^2 - 5x + 6 = 0  OR  sin(30)" value="x^2 - 5x + 6 = 0" />
        <select id="modeSelect" title="Mode">
          <option value="auto">Auto Detect</option>
          <option value="eval">Expression Evaluate</option>
          <option value="linear">Solve Linear (ax + b = c)</option>
          <option value="quadratic">Solve Quadratic (ax^2 + bx + c = 0)</option>
          <option value="func">Function Evaluate</option>
        </select>
        <div style="display:flex;gap:8px;align-items:center;">
          <label style="font-weight:700;font-size:13px;margin-right:6px">Degrees</label>
          <input id="degToggle" type="checkbox" title="Use degrees for trig" />
        </div>
        <div style="display:flex;gap:8px;">
          <button id="solveBtn" class="primary">Solve</button>
          <button id="copyBtn" class="btn ghost">Copy</button>
        </div>
      </div>
    </div>
  </section>

  <main class="grid" role="main">
    <div>
      <section class="card">
        <h2>Result</h2>
        <div class="hint">Solution and—if applicable—step-by-step explanation below.</div>
        <div id="resultBox" class="result-block">No result yet. Enter a problem and click Solve.</div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="downloadBtn" class="btn ghost">Download .txt</button>
          <button id="clearHistory" class="btn ghost">Clear History</button>
          <div style="flex:1"></div>
          <div class="muted" id="statusMsg" aria-live="polite"></div>
        </div>
      </section>

      <section class="card" style="margin-top:12px">
        <h2>Input helpers</h2>
        <div class="hint">Quick examples & tips</div>
        <ul style="margin:8px 0 0 18px;color:var(--muted)">
          <li><strong>Expression:</strong> 3*(2+sqrt(5)) + sin(0.5)</li>
          <li><strong>Linear:</strong> 2x + 3 = 7  or  x + 4 = 10</li>
          <li><strong>Quadratic:</strong> x^2 - 5x + 6 = 0  or  2x^2+3x-5=0</li>
          <li><strong>Functions:</strong> sin(30) (use degrees toggle), cos(pi/4), log(10)</li>
        </ul>
      </section>
    </div>

    <aside>
      <div class="feature-panel card">
        <div class="panel-title">History</div>
        <div id="historyList" class="history-list"></div>

        <div class="spacer" style="height:12px"></div>

        <div class="panel-title">Why this tool?</div>
        <div style="color:var(--muted);font-size:13px">
          Private & offline — everything runs in your browser. Small, fast, and easy to fork.
        </div>

        <div style="height:12px"></div>
        <a class="visit" href="https://pirateruler.com" target="_blank" rel="noopener noreferrer">Visit PirateRuler.com</a>
      </div>
    </aside>
  </main>

  <footer>
    <div style="height:8px"></div>
    <small class="muted">© <span id="year"></span> PirateRuler — Math Solver (offline)</small>
  </footer>
</div>

<!-- sidebar -->
<aside id="sidebar" class="sidebar" style="position:fixed;top:0;right:0;height:100vh;width:360px;transform:translateX(120%);transition:transform .28s;z-index:90;background:var(--card);padding:18px;border-left:1px solid rgba(0,0,0,0.04);">
  <div style="display:flex;justify-content:flex-end"><button id="closeSidebar" class="btn ghost">Close</button></div>
  <h3>PirateRuler Links</h3>
  <nav style="display:flex;flex-direction:column;gap:8px;margin-top:10px">
    <a href="https://pirateruler.com/post/about.html" target="_blank">About — PirateRuler</a>
    <a href="https://pirateruler.com/post/privacy.html" target="_blank">Privacy Policy</a>
    <a href="https://pirateruler.com/post/contact.html" target="_blank">Contact</a>
    <a href="https://pirateruler.com/post/terms.html" target="_blank">Terms</a>
  </nav>
</aside>

<script>
/* Math Solver — client side only
   - Safe-ish evaluator that whitelists known functions and characters.
   - Linear / quadratic solver with step-by-step.
   - History saved to localStorage.
*/

const el = id => document.getElementById(id);
el('year').textContent = new Date().getFullYear();

// UI elements
const inputProblem = el('inputProblem');
const modeSelect = el('modeSelect');
const solveBtn = el('solveBtn');
const resultBox = el('resultBox');
const copyBtn = el('copyBtn');
const downloadBtn = el('downloadBtn');
const historyList = el('historyList');
const clearHistoryBtn = el('clearHistory');
const degToggle = el('degToggle');
const statusMsg = el('statusMsg');

const hambBtn = el('hambBtn'), sidebar = el('sidebar'), closeSidebar = el('closeSidebar');
hambBtn.addEventListener('click', ()=> { sidebar.style.transform='translateX(0)'; sidebar.setAttribute('aria-hidden','false'); });
closeSidebar.addEventListener('click', ()=> { sidebar.style.transform='translateX(120%)'; sidebar.setAttribute('aria-hidden','true'); });

/* ---------- SAFETY: allowed functions & replacements ---------- */
const ALLOWED_FN = ['sin','cos','tan','asin','acos','atan','sqrt','abs','log','ln','exp','pow','max','min','floor','ceil','round'];
// map user-friendly names to Math.*
const FN_MAP = {
  'ln':'Math.log',
  'log':'Math.log10 || (Math.log10 ? Math.log10 : (x=>Math.log(x)/Math.LN10))',
  'sqrt':'Math.sqrt',
  'abs':'Math.abs',
  'exp':'Math.exp',
  'pow':'Math.pow',
  'max':'Math.max',
  'min':'Math.min',
  'floor':'Math.floor',
  'ceil':'Math.ceil',
  'round':'Math.round',
  'sin':'Math.sin',
  'cos':'Math.cos',
  'tan':'Math.tan',
  'asin':'Math.asin','acos':'Math.acos','atan':'Math.atan'
};

// helper: convert degrees to radians when deg toggle enabled
function withAngleWrappers(expr, useDegrees){
  if(!useDegrees) return expr;
  // replace sin(x) with Math.sin((x)*Math.PI/180) via safe replacement
  // naive approach: wrap common trig function calls
  return expr.replace(/\b(sin|cos|tan|asin|acos|atan)\s*\(/g, (m,fn) => {
    // if inverse function (asin/acos/atan) expects radians output; keep as-is for inverse
    if(fn === 'asin' || fn === 'acos' || fn === 'atan') return `Math.${fn}(`;
    // normal trig -> convert degrees input to radians
    return `Math.${fn}((`;
  }).replace(/\bMath\.(sin|cos|tan)\(\(/g, (m,fn)=> `Math.${fn}(`).replace(/\)\)/g, ')*Math.PI/180)');
  // Note: we keep this simple; complex nested expressions still work for most user inputs.
}

/* sanitize and prepare expression to safely evaluate */
function prepareExpression(raw, useDegrees=false){
  // basic sanitize: allow letters, numbers, spaces, math symbols, parentheses, comma, dot, ^, e and E
  const cleaned = raw.replace(/[,]/g, ','); // keep comma
  // Reject suspicious chars early
  if(/[;{}]/.test(cleaned)) throw new Error('Invalid characters in expression.');

  // replace ^ with ** for exponent (JS)
  let expr = cleaned.replace(/\^/g, '**');

  // replace known function names with Math.* (note: we will allow only listed functions)
  // find words and replace if in FN_MAP
  expr = expr.replace(/\b([a-zA-Z_][a-zA-Z0-9_]*)\s*\(/g, (m, name) => {
    const lname = name.toLowerCase();
    if(ALLOWED_FN.includes(lname)) {
      return (FN_MAP[lname] ? FN_MAP[lname] : ('Math.'+lname)) + '(';
    }
    // if the name looks like a variable 'x' we keep 'x(' which is invalid for evaluation and will error
    return name + '(';
  });

  // add Math. prefix for constants like pi, e
  expr = expr.replace(/\bpi\b/ig, 'Math.PI');
  expr = expr.replace(/\be\b/g, 'Math.E');

  // insert degree conversions if enabled
  if(useDegrees){
    // Simple approach: wrap trig functions -- handled in withAngleWrappers
    expr = withAngleWrappers(expr, true);
  }

  // Now final safety check: only allow digits, Math, parentheses, operators, letters used in Math.* and allowed fn replacements, comma, decimal, and **.
  // Deny if suspicious tokens like "constructor" or "prototype" appear
  if(/constructor|prototype|window|document|Function|eval|=>/.test(expr)) throw new Error('Unsafe expression.');
  return expr;
}

/* evaluate numeric expression safely (best-effort) */
function evaluateExpression(raw){
  const useDegrees = !!degToggle.checked;
  const expr = prepareExpression(raw, useDegrees);
  // final guard: allow only limited characters
  if(!/^[0-9\s+\-*/%^().*MathPIE,**eE]+[0-9MathPIE\s+\-*/%^().,*]*$/i.test(expr) && !/Math\./.test(expr)) {
    // don't block too aggressively — allow through but wrap in try/catch
  }
  // Use Function to evaluate numeric expression in strict mode
  try{
    const fn = new Function('"use strict"; return (' + expr + ');');
    const val = fn();
    if(typeof val === 'number' && Number.isFinite(val)) return { ok:true, value: val };
    return { ok:false, error: 'Result is not a finite number' };
  }catch(err){
    return { ok:false, error: err.message || String(err) };
  }
}

/* ---------- Linear solver (ax + b = c) ---------- */
function solveLinear(raw){
  // Normalize: replace spaces, handle forms like 2x+3=7 or x+4=10
  const s = raw.replace(/\s+/g,'').replace(/\−/g,'-'); // sometimes minus char
  const parts = s.split('=');
  if(parts.length !== 2) return { ok:false, error:'Equation must contain one = sign.' };
  const left = parts[0], right = parts[1];

  // Move everything to left: left - right = 0
  // We'll try to parse coefficients of x by matching regex terms
  // Convert implicit 1x to 1*x to ease parsing
  const norm = (st) => st.replace(/(^|[+\-])x/ig, (m, sign) => (sign||'') + '1*x');
  const L = norm(left);
  const R = norm(right);

  // Extract terms by splitting on + and - while keeping sign
  function collectTerms(expr){
    const arr = expr.replace(/-/g,'+-').split('+').filter(Boolean);
    return arr;
  }

  const leftTerms = collectTerms(L);
  const rightTerms = collectTerms(R);

  // collect a*x terms and constants
  let a = 0, b = 0;
  const pushTerm = t => {
    if(/\*x/i.test(t)) {
      // coefficient before *x
      const coeff = t.split('*')[0];
      const val = Number(coeff);
      if(isNaN(val)) throw new Error('Invalid coefficient: ' + coeff);
      a += val;
    } else {
      // constant term
      const val = Number(t);
      if(isNaN(val)) throw new Error('Invalid numeric term: ' + t);
      b += val;
    }
  };

  try{
    leftTerms.forEach(pushTerm);
    // subtract right side terms
    rightTerms.forEach(t => {
      // negate term
      if(/\*x/i.test(t)) {
        const coeff = t.split('*')[0];
        const val = Number(coeff);
        if(isNaN(val)) throw new Error('Invalid coefficient: ' + coeff);
        a -= val;
      } else {
        const val = Number(t);
        if(isNaN(val)) throw new Error('Invalid numeric term: ' + t);
        b -= val;
      }
    });
  }catch(e){
    return { ok:false, error: e.message };
  }

  // Now equation is a*x + b = 0 => x = -b/a
  if(Math.abs(a) < 1e-12) {
    if(Math.abs(b) < 1e-12) return { ok:true, type:'infinite', steps:[`Equation reduces to 0 = 0 — infinitely many solutions.`] };
    return { ok:true, type:'none', steps:[`Coefficient of x is 0 but constant is ${b}; no solution.`] };
  }
  const x = -b / a;
  const steps = [
    `Normalized equation: (${a})·x + (${b}) = 0`,
    `Solve for x: x = -(${b}) / (${a})`,
    `x = ${roundSmart(x)}`
  ];
  return { ok:true, type:'single', root:x, steps };
}

/* ---------- Quadratic solver (ax^2 + bx + c = 0) ---------- */
function solveQuadratic(raw){
  // basic normalization: remove spaces, handle ^2, implicit 1 coefficients, and support x^2, 2x^2, -x^2, etc.
  const s = raw.replace(/\s+/g,'').replace(/\−/g,'-');
  const parts = s.split('=');
  if(parts.length > 2) return { ok:false, error:'Equation must have at most one = sign.' };
  // move all to left side: left - right
  const left = parts[0] || '';
  const right = parts[1] || '';
  const expr = '(' + left + ')-(' + (right||'0') + ')';

  // We want to extract numeric a,b,c for x^2, x, constant
  // Strategy: replace x^2 terms into token +, then evaluate coefficients by substituting x with variables.
  // Simpler: replace x^2 with "*X2*", x with "*X*", then split terms
  // But safer approach: use regex to find all x^2 and x terms and remove them to compute constants.

  // Insert explicit multiplication for implicit coefficients
  let norm = expr.replace(/(^|[+\-])x\^2/ig, (m, sign)=> (sign||'') + '1*x^2');
  norm = norm.replace(/(^|[+\-])x(?![\^0-9a-zA-Z_])/ig, (m, sign)=> (sign||'') + '1*x');
  // Ensure forms like 2x^2 -> 2*x^2
  norm = norm.replace(/([0-9])x/g, '$1*x').replace(/([0-9])x\^/g, '$1*x^');

  // Now find coefficients using regex
  const aMatches = norm.match(/([+\-]?\d*\.?\d+)\*x\^2/ig) || [];
  const bMatches = norm.match(/([+\-]?\d*\.?\d+)\*x(?!\^)/ig) || [];
  const cMatches = norm.replace(/([+\-]?\d*\.?\d+)\*x\^2/ig,'').replace(/([+\-]?\d*\.?\d+)\*x(?!\^)/ig,'').match(/([+\-]?\d*\.?\d+)/g) || [];

  const toNum = s => Number(s.replace(/\*/g,''));
  let a = 0, b = 0, c = 0;
  try{
    aMatches.forEach(m => { a += Number(m.replace('*x^2','')); });
    bMatches.forEach(m => { b += Number(m.replace('*x','')); });
    // cMatches may include stray parentheses; filter numbers
    cMatches.forEach(m => {
      const n = Number(m);
      if(!isNaN(n)) c += n;
    });
  }catch(e){
    return { ok:false, error:'Failed to parse quadratic coefficients.' };
  }

  // If no x^2 in input, treat as not quadratic
  if(Math.abs(a) < 1e-12) return { ok:false, error:'Not a quadratic equation (a = 0).' };

  // discriminant
  const disc = b*b - 4*a*c;
  const steps = [];
  steps.push(`Normalized coefficients: a = ${a}, b = ${b}, c = ${c}`);
  steps.push(`Discriminant Δ = b² - 4ac = (${b})² - 4·${a}·${c} = ${roundSmart(disc)}`);

  if(disc > 0){
    const r1 = (-b + Math.sqrt(disc)) / (2*a);
    const r2 = (-b - Math.sqrt(disc)) / (2*a);
    steps.push(`Two real roots: x = (-b ± √Δ) / (2a)`);
    steps.push(`x₁ = ${roundSmart(r1)}, x₂ = ${roundSmart(r2)}`);
    return { ok:true, type:'two', roots:[r1,r2], steps };
  } else if(Math.abs(disc) < 1e-12){
    const r = -b/(2*a);
    steps.push(`One real repeated root: x = -b / (2a) = ${roundSmart(r)}`);
    return { ok:true, type:'one', roots:[r], steps };
  } else {
    // complex roots
    const re = -b/(2*a);
    const im = Math.sqrt(Math.abs(disc)) / (2*a);
    steps.push(`Complex roots: x = ${roundSmart(re)} ± ${roundSmart(im)}i`);
    return { ok:true, type:'complex', roots:[ `${roundSmart(re)} + ${roundSmart(im)}i`, `${roundSmart(re)} - ${roundSmart(im)}i` ], steps };
  }
}

/* ---------- helpers ---------- */
function roundSmart(n){
  if(typeof n !== 'number') return String(n);
  if(Math.abs(n) < 1e-12) return '0';
  if(Math.abs(n) < 1e-3 || Math.abs(n) > 1e7) return n.toPrecision(6);
  return Number.isInteger(n) ? String(n) : String(Number(n.toFixed(8))).replace(/\.?0+$/,'');
}

/* detect mode automatically */
function detectMode(input){
  const s = input.trim();
  if(/\=/.test(s)){
    // equation present — decide linear or quadratic by x^2
    if(/x\^2|X\^2|x2|X2/.test(s)) return 'quadratic';
    return 'linear';
  }
  // function-like
  if(/\b(sin|cos|tan|sqrt|log|ln|exp|min|max)\(/i.test(s)) return 'func';
  // otherwise expression
  return 'eval';
}

/* ---------- History management ---------- */
const HISTORY_KEY = 'pr-math-history-v1';
function loadHistory(){
  try{
    const raw = localStorage.getItem(HISTORY_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch(e){ return []; }
}
function saveHistory(arr){
  localStorage.setItem(HISTORY_KEY, JSON.stringify(arr.slice(0,200))); // cap 200
}
function addHistory(entry){
  const arr = loadHistory();
  arr.unshift(entry);
  saveHistory(arr);
  renderHistory();
}
function clearHistory(){
  localStorage.removeItem(HISTORY_KEY);
  renderHistory();
}
function renderHistory(){
  const arr = loadHistory();
  historyList.innerHTML = '';
  if(arr.length === 0){
    historyList.innerHTML = '<div class="muted">No history yet.</div>';
    return;
  }
  arr.forEach((h, i) => {
    const div = document.createElement('div');
    div.className = 'history-item';
    div.innerHTML = `<div style="flex:1"><div style="font-weight:800">${escapeHtml(h.input)}</div><div style="font-size:12px;color:var(--muted)">${h.mode} · ${new Date(h.ts).toLocaleString()}</div></div>`;
    const actions = document.createElement('div');
    const useBtn = document.createElement('button'); useBtn.className='btn ghost'; useBtn.textContent='Use';
    useBtn.addEventListener('click', ()=> { inputProblem.value = h.input; modeSelect.value = h.mode === 'auto' ? 'auto' : h.mode; inputProblem.focus(); });
    const delBtn = document.createElement('button'); delBtn.className='btn ghost'; delBtn.textContent='Delete';
    delBtn.addEventListener('click', ()=> {
      const newArr = loadHistory().filter((_, idx) => idx !== i);
      saveHistory(newArr);
      renderHistory();
    });
    actions.appendChild(useBtn); actions.appendChild(delBtn);
    div.appendChild(actions);
    historyList.appendChild(div);
  });
}

/* ---------- UI actions ---------- */
function setStatus(msg, timeout=1600){
  statusMsg.textContent = msg;
  if(timeout>0) setTimeout(()=> { if(statusMsg.textContent === msg) statusMsg.textContent = ''; }, timeout);
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function showResultBlock(text){
  resultBox.textContent = text;
}

/* Solve button */
solveBtn.addEventListener('click', ()=> doSolve());
inputProblem.addEventListener('keydown', (e)=> { if(e.key === 'Enter') doSolve(); });

function doSolve(){
  const raw = inputProblem.value.trim();
  if(!raw){ alert('Type a problem first'); return; }
  const userMode = modeSelect.value;
  const mode = userMode === 'auto' ? detectMode(raw) : userMode;
  try{
    let out = '', steps = [];
    if(mode === 'eval'){
      const res = evaluateExpression(raw);
      if(!res.ok) { showResultBlock('Error: ' + res.error); return; }
      out = `${roundSmart(res.value)}`;
      steps.push(`Evaluated expression: ${raw}`);
      steps.push(`Result: ${out}`);
    } else if(mode === 'func'){
      const res = evaluateExpression(raw);
      if(!res.ok) { showResultBlock('Error: ' + res.error); return; }
      out = `${roundSmart(res.value)}`;
      steps.push(`Function evaluated: ${raw}`);
      steps.push(`Result: ${out}`);
    } else if(mode === 'linear'){
      const sol = solveLinear(raw);
      if(!sol.ok) { showResultBlock('Error: ' + sol.error); return; }
      if(sol.type === 'infinite') {
        out = 'Infinite solutions';
        steps = sol.steps;
      } else if(sol.type === 'none') {
        out = 'No solution';
        steps = sol.steps;
      } else {
        out = `x = ${roundSmart(sol.root)}`;
        steps = sol.steps;
      }
    } else if(mode === 'quadratic'){
      const sol = solveQuadratic(raw);
      if(!sol.ok) { showResultBlock('Error: ' + sol.error); return; }
      if(sol.type === 'two'){
        out = `x₁ = ${roundSmart(sol.roots[0])}\n x₂ = ${roundSmart(sol.roots[1])}`;
        steps = sol.steps;
      } else if(sol.type === 'one'){
        out = `x = ${roundSmart(sol.roots[0])}`;
        steps = sol.steps;
      } else if(sol.type === 'complex'){
        out = `x₁ = ${sol.roots[0]}\n x₂ = ${sol.roots[1]}`;
        steps = sol.steps;
      }
    } else {
      // fallback: evaluate expression
      const res = evaluateExpression(raw);
      if(!res.ok) { showResultBlock('Error: ' + res.error); return; }
      out = `${roundSmart(res.value)}`;
      steps.push(`Evaluated (fallback): ${raw}`);
      steps.push(`Result: ${out}`);
    }

    // render nicely
    const outputText = `Input: ${raw}\nMode: ${mode}\n\nSolution:\n${out}\n\nSteps:\n${(steps && steps.length) ? steps.join('\n') : 'No steps available.'}`;
    showResultBlock(outputText);

    // add to history
    addHistory({ input: raw, mode, result: out, ts: Date.now() });

    setStatus('Solved ✔');
  }catch(err){
    showResultBlock('Error: ' + (err.message || String(err)));
  }
}

/* copy & download */
copyBtn.addEventListener('click', async ()=> {
  try{
    await navigator.clipboard.writeText(resultBox.textContent || '');
    setStatus('Copied');
  }catch(e){
    alert('Copy failed');
  }
});
downloadBtn.addEventListener('click', ()=> {
  const text = resultBox.textContent || '';
  if(!text) return alert('Nothing to download.');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text], {type:'text/plain'}));
  a.download = 'pirateruler-math-result.txt';
  a.click();
  URL.revokeObjectURL(a.href);
});

/* clear history */
clearHistoryBtn.addEventListener('click', ()=> {
  if(!confirm('Clear all history?')) return;
  clearHistory();
});

/* theme handling */
const themeBtn = el('themeBtn'), themeList = el('themeList'), themeItems = document.querySelectorAll('.theme-item');
themeBtn.addEventListener('click', ()=> themeList.style.display = themeList.style.display==='block' ? 'none' : 'block');
themeItems.forEach(it => it.addEventListener('click', ()=> {
  const t = it.dataset.theme;
  ['dark','ocean','sunset'].forEach(c=> document.documentElement.classList.remove(c));
  if(t !== 'light') document.documentElement.classList.add(t);
  themeBtn.textContent = (t.charAt(0).toUpperCase()+t.slice(1)) + ' ▾';
  localStorage.setItem('pr-theme', t);
  themeList.style.display = 'none';
}));
(function initTheme(){ const t = localStorage.getItem('pr-theme') || 'ocean'; if(t !== 'light') document.documentElement.classList.add(t); themeBtn.textContent = (t.charAt(0).toUpperCase()+t.slice(1)) + ' ▾'; })();

/* click outside to hide theme list */
document.addEventListener('click', (e)=> { if(!document.getElementById('themeSelectWrap')?.contains(e.target)) themeList.style.display='none'; });

/* initial render */
renderHistory();
</script>
</body>
</html>
